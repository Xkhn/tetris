var STEP=25;var ROW_COUNT=16,COL_COUNT=9;colcount=5;var currentModel={};var newModel={};var color="";var mark=0;var maxScore=0;var fixedBlocks={};var currentX=0,currentY=0;var oldX=0,oldY=0;var Level="第一关";var LevelNumber=1;var mInterval=null;var BounsPoints=0;var Speed=0;var Number=0;var Game=true;var MusicPlay=false;var RotatePlay=false;var MoDELS=[{0:{row:2,col:1},1:{row:2,col:2},2:{row:2,col:3},3:{row:1,col:3}},{0:{row:1,col:2},1:{row:2,col:1},2:{row:2,col:2},3:{row:2,col:3}},{0:{row:1,col:2},1:{row:2,col:2},2:{row:1,col:3},3:{row:2,col:3}},{0:{row:2,col:1},1:{row:2,col:2},2:{row:2,col:3},3:{row:2,col:4}},{0:{row:1,col:1},1:{row:1,col:2},2:{row:2,col:2},3:{row:2,col:3}}];function init(){ScreenWidth();BestScore();StartSetting();NextModel();Create();onKeyDown();onTouch()}function NextModel(){var doc=document;newModel=MoDELS[_.random(0,MoDELS.length-1)];color=getColor();var Color=color;for(var key in newModel){var block=document.createElement("div");block.className="new_model";block.style.background=Color;doc.getElementById("next_block").appendChild(block);var phoneblock=doc.createElement("div");phoneblock.className="model_new";phoneblock.style.background=Color;doc.getElementById("NextModelArea").appendChild(phoneblock)}var allPCblock=doc.getElementsByClassName("new_model"),allPhoneBlock=doc.getElementsByClassName("model_new");for(var i=0;i<allPCblock.length;i++){var singelPCblcok=allPCblock[i],singelPhoneblock=allPhoneBlock[i],blockModel=newModel[i],step=STEP;singelPCblcok.style.top=blockModel.row*step+"px";singelPCblcok.style.left=blockModel.col*step+"px";singelPhoneblock.style.top=blockModel.row*15+"px";singelPhoneblock.style.left=blockModel.col*15+"px"}Color=null;step=null;singelPCblcok=null;singelPhoneblock=null;blockModel=null}function ScreenWidth(){var doc=document;if(screen.width>=1200){STEP=40;ROW_COUNT=18,COL_COUNT=10;var rect=doc.getElementById("container").getBoundingClientRect();doc.getElementById("Ranking").style.top=rect.bottom-650+"px";doc.getElementById("Ranking").style.left=rect.left+30+"px"}else{if(screen.width<450){STEP=parseInt((screen.width-135)/9);var step=STEP;doc.getElementsByClassName("screen")[0].style.height=(step*16)+30+"px";doc.getElementsByClassName("screen")[0].style.width=step*9+25+"px";doc.getElementById("TouchArea").style.height=step*16+"px";doc.getElementById("TouchArea").style.width=step*9+"px";doc.getElementById("container").style.height=step*16+3+"px";doc.getElementById("container").style.width=step*10+"px";doc.getElementById("MiddleArea").style.top=(screen.height-300)/2+"px";doc.getElementById("MiddleArea").style.left=(screen.width-200)/2+"px";doc.getElementById("Ranking").style.top=(screen.height-640)/2+"px";doc.getElementById("Ranking").style.left=(screen.width-320)/2+"px";doc.getElementById("SettingContainer").style.top=(screen.height-300)/2+"px";doc.getElementById("SettingContainer").style.left=(screen.width-200)/2+"px"}}step=null;rect=null}function LevelAnimation(number){var doc=document;doc.getElementById("LevelContainer").innerHTML="<div class='level'id='levelnumber'>"+number+"</div>";doc.getElementById("levelnumber").style.top=(STEP*16-60)/2+"px";doc.getElementById("levelnumber").style.left=(STEP*9-100)/2+"px";setTimeout("document.getElementsByClassName('level')[0].style.visibility = 'hidden',document.getElementsByClassName('level')[0].style.opacity = '0'",1000)}function playmusic(music){if(MusicPlay==true){if(music=="move"){var audio=new Audio("./assert/move.mp3");audio.play()}else{if(music=="clear"){var audio=new Audio("./assert/clear.mp3");audio.play()}else{var audio=new Audio("./assert/all.mp3");audio.play()}}}audio=null}function BounsPoint(Point){document.getElementById("PointContainer").innerHTML="<div class='Point'>+"+Point+"</div>";setTimeout("document.getElementsByClassName('Point')[0].style.visibility = 'hidden',document.getElementsByClassName('Point')[0].style.top = '310px',document.getElementsByClassName('Point')[0].style.opacity = '0'",500)}function getColor(){var Arr=["#ffb444","#f16060","#cc50ff","#ff90ec","#49ff49","#79f7ce"];var n=Math.floor(Math.random()*Arr.length+1)-1;return Arr[n]}function Create(){var doc=document;if(isGameOver()){gameOver();return}currentModel=newModel;currentX=-3;currentY=-3;var hue=color;for(var key in currentModel){var NowModel=doc.createElement("div");NowModel.className="activity_model";NowModel.style.background=hue;if(RotatePlay==true){NowModel.style.transition="all 0.1s ease 0s"}if(screen.width<450){NowModel.style.width=STEP-3+"px";NowModel.style.height=STEP-3+"px"}doc.getElementById("container").appendChild(NowModel)}locationmodel();if(mark<500){Speed=1000;Level="第一关";doc.getElementById("TopLevel").innerHTML="";doc.getElementById("TopLevel").innerHTML="1";if(LevelNumber<2){LevelAnimation(Level);LevelNumber+=1}}else{if(mark>=500&&mark<1000){Level="第二关";Speed=800;doc.getElementById("TopLevel").innerHTML="";doc.getElementById("TopLevel").innerHTML="2";if(LevelNumber>=2&&LevelNumber<3){LevelAnimation(Level);LevelNumber+=1
}}else{if(mark>=1000&&mark<1500){Level="第三关";Speed=700;doc.getElementById("TopLevel").innerHTML="";doc.getElementById("TopLevel").innerHTML="3";if(LevelNumber>=3&&LevelNumber<4){LevelAnimation(Level);LevelNumber+=1}}else{if(mark>=1500&&mark<2500){Level="第四关";Speed=500;doc.getElementById("TopLevel").innerHTML="";doc.getElementById("TopLevel").innerHTML="4";if(LevelNumber>=4&&LevelNumber<5){LevelAnimation(Level);LevelNumber+=1}}else{if(mark>=2500&&mark<3500){Level="第五关";Speed=300;doc.getElementById("TopLevel").innerHTML="";doc.getElementById("TopLevel").innerHTML="5";if(LevelNumber>=5&&LevelNumber<6){LevelAnimation(Level);LevelNumber+=1}}else{if(mark>=3500&&mark<5000){Level="第六关";Speed=200;doc.getElementById("TopLevel").innerHTML="";doc.getElementById("TopLevel").innerHTML="6";if(LevelNumber>=6&&LevelNumber<7){LevelAnimation(Level);LevelNumber+=1}}else{Level="无敌关";Speed=10;doc.getElementById("TopLevel").innerHTML="";doc.getElementById("TopLevel").innerHTML="7";if(LevelNumber>=7&&LevelNumber<8){LevelAnimation(Level);LevelNumber+=1}}}}}}}autoDown(Speed);removenew();NextModel();hue=null}function locationmodel(){CheckBoundary();var Allblcok=document.getElementsByClassName("activity_model");for(var i=0;i<Allblcok.length;i++){var singelblock=Allblcok[i],blockModel=currentModel[i],step=STEP;singelblock.style.top=(currentY+blockModel.row)*step+"px";singelblock.style.left=(currentX+blockModel.col)*step+"px"}Allblcok=null;singelblock=null;blockModel=null;step=null}function move(x,y){var oldX=currentX;if(x>1){for(var i=1;i<x;i++){if(isMeet(currentX+i,currentY+y,currentModel)){if(y!==0){fixblocks()}return}currentX++;locationmodel()}}else{if(isMeet(currentX+x,currentY+y,currentModel)){if(y!==0){fixblocks()}return}}currentX+=x;currentY+=y;locationmodel();if(oldX!=currentX){playmusic("move")}oldX=null}function onKeyDown(){document.onkeydown=function(event){switch(event.keyCode){case 38:rotate();break;case 39:move(1,0);break;case 40:autoDown(35);break;case 37:move(-1,0);break}}}function rotate(){if(currentModel==MoDELS[2]){return}var cloneCurrentModel=_.cloneDeep(currentModel);for(var key in cloneCurrentModel){var abc=cloneCurrentModel[key];var temp=abc.row;abc.row=abc.col;abc.col=3-temp}if(isMeet(currentX,currentY,cloneCurrentModel)){return}currentModel=cloneCurrentModel;locationmodel();cloneCurrentModel=null;abc=null;temp=null}function CheckBoundary(){var leftBound=0,rightBound=COL_COUNT,bottomBound=ROW_COUNT;for(var key in currentModel){var SingelBlock=currentModel[key];if((SingelBlock.col+currentX)<leftBound){currentX++}else{if((SingelBlock.col+currentX)>=rightBound){currentX--}else{if((SingelBlock.row+currentY)>=bottomBound){currentY--;fixblocks()}}}}rightBound=null;bottomBound=null}function fixblocks(){var fix=document.getElementsByClassName("activity_model");for(var i=fix.length-1;i>=0;i--){var fixblock=fix[i];fixblock.className="fixed_model";var block=currentModel[i];fixedBlocks[(currentY+block.row)+"_"+(currentX+block.col)]=fixblock}isRemoveLine();Create();block=null;fix=null;fixblock=null}function isMeet(x,y,model){for(var key in model){var block=model[key];if(fixedBlocks[(y+block.row)+"_"+(x+block.col)]){return true}}block=null;return false}function removenew(){var doc=document,Nextblock=doc.getElementById("next_block"),Nextmodelarea=doc.getElementById("NextModelArea");Nextblock.innerHTML="";Nextmodelarea.innerHTML=""}function isRemoveLine(){var FIXEDBLOCKS=fixedBlocks;for(var i=0;i<ROW_COUNT;i++){var flag=true;for(var j=0;j<COL_COUNT;j++){if(!FIXEDBLOCKS[i+"_"+j]){flag=false;break}}if(flag){BounsPoints+=100;addPoint();removeLine(i)}}if(BounsPoints>0){BounsPoint(BounsPoints);BounsPoints=0}else{playmusic("clear")}FIXEDBLOCKS=null}function removeLine(line){for(var i=0;i<COL_COUNT;i++){fixedBlocks[line+"_"+i].style.height=0+"px";document.getElementById("container").removeChild(fixedBlocks[line+"_"+i]);fixedBlocks[line+"_"+i]=null}downLine(line);playmusic("all")}function downLine(line){for(var i=line-1;i>=0;i--){for(var j=0;j<COL_COUNT;j++){if(!fixedBlocks[i+"_"+j]){continue}fixedBlocks[(i+1)+"_"+j]=fixedBlocks[i+"_"+j];var step=STEP;fixedBlocks[(i+1)+"_"+j].style.top=(i+1)*step+"px";fixedBlocks[i+"_"+j]=null}}step=null}function autoDown(x){if(mInterval){clearInterval(mInterval)}mInterval=setInterval(function(){move(0,1)},x)}function isGameOver(){for(var i=0;i<COL_COUNT;i++){if(fixedBlocks["0_"+i]){return true}}return false}function sort(arr){for(var i=0;i<arr.length-1;i++){for(var j=0;j<arr.length-i-1;j++){if(arr[j]>arr[j+1]){var hand=arr[j];arr[j]=arr[j+1];arr[j+1]=hand}}}return arr}function binaryInsertSort(arr){for(var i=1;i<arr.length;i++){var key=arr[i],left=0,right=i-1;while(left<=right){var middle=parseInt((left+right)/2);if(key<arr[middle]){right=middle-1}else{left=middle+1}}for(var j=i-1;j>=left;j--){arr[j+1]=arr[j]}arr[left]=key}return arr}function gameOver(){var doc=document;if(mInterval){Game=false;clearInterval(mInterval)}Ranking=localStorage.getItem("Ranking");Ranking=null?[0,0,0,0,0,0,0,0,0,0]:Ranking.split(",");
Ranking=JSON.parse("["+String(Ranking)+"]");for(var i=0;i<Ranking.length;i++){if(mark>Ranking[i]){Ranking.pop();Ranking.push(mark);var wee=sort(Ranking),NewRanking=binaryInsertSort(Ranking).reverse(),allranking=doc.getElementById("AllRanking");localStorage.setItem("Ranking",NewRanking);doc.getElementById("AllRanking").innerHTML="";for(var j=0;j<NewRanking.length;j++){var nowj=j+1;if(j==0){var singleRanking=doc.createElement("li");singleRanking.innerHTML="<div>🥇</div>"+NewRanking[j];allranking.append(singleRanking)}else{if(j==1){var singleRanking=doc.createElement("li");singleRanking.innerHTML="<div>🥈</div>"+NewRanking[j];allranking.append(singleRanking)}else{if(j==2){var singleRanking=doc.createElement("li");singleRanking.innerHTML="<div>🥉</div>"+NewRanking[j];allranking.append(singleRanking)}else{var singleRanking=doc.createElement("li");singleRanking.innerHTML="<div>"+nowj+"</div>"+NewRanking[j];allranking.append(singleRanking)}}}}if(mark==NewRanking[0]){doc.getElementById("result").innerHTML="";doc.getElementById("result").innerHTML="恭喜你获得👑";doc.getElementById("MaxMark").innerHTML="👑 "+mark;doc.getElementById("PhoneMaxmark").innerHTML=mark;if(screen.width<450){doc.getElementById("MiddleArea").style.display="inline"}else{alert("恭喜你获得👑")}}else{if(mark==NewRanking[1]){doc.getElementById("result").innerHTML="";doc.getElementById("result").innerHTML="恭喜你获得第二名";if(screen.width<450){doc.getElementById("MiddleArea").style.display="inline"}else{alert("恭喜你获得第二名")}}else{if(mark==NewRanking[2]){doc.getElementById("result").innerHTML="";doc.getElementById("result").innerHTML="恭喜你获得第三名";if(screen.width<450){doc.getElementById("MiddleArea").style.display="inline"}else{alert("恭喜你获得第三名")}}else{doc.getElementById("result").innerHTML="";doc.getElementById("result").innerHTML="恭喜你进入了排行榜";if(screen.width<450){doc.getElementById("MiddleArea").style.display="inline"}else{alert("恭喜你进入了排行榜")}}}}break}else{Number++;if(Number==9){doc.getElementById("result").innerHTML="";doc.getElementById("result").innerHTML="很遗憾未能入榜，加油哦";Number==0;if(screen.width<450){doc.getElementById("MiddleArea").style.display="inline"}else{alert("很遗憾你没有入榜")}break}}}wee=null;NewRanking=null}function addPoint(){var doc=document;mark+=100;doc.getElementById("PCmark").innerHTML="";doc.getElementById("PCmark").innerHTML="🌟  "+mark;doc.getElementById("Phonemark").innerHTML="";doc.getElementById("Phonemark").innerHTML=mark}function BestScore(){var doc=document;var allRanking=doc.getElementById("AllRanking");allRanking.innerHTML="";NewScore=[0,0,0,0,0,0,0,0,0,0];maxScore=localStorage.getItem("Ranking");maxScore=maxScore==null?NewScore:maxScore.split(",");doc.getElementById("MaxMark").innerHTML="👑 "+maxScore[0];doc.getElementById("PhoneMaxmark").innerHTML=maxScore[0];for(var j=0;j<maxScore.length;j++){var nowj=j+1;if(j==0){var singleRanking=doc.createElement("li");singleRanking.innerHTML="<div>🥇</div>"+maxScore[j];allRanking.append(singleRanking)}else{if(j==1){var singleRanking=doc.createElement("li");singleRanking.innerHTML="<div>🥈</div>"+maxScore[j];allRanking.append(singleRanking)}else{if(j==2){var singleRanking=doc.createElement("li");singleRanking.innerHTML="<div>🥉</div>"+maxScore[j];allRanking.append(singleRanking)}else{var singleRanking=doc.createElement("li");singleRanking.innerHTML="<div>"+nowj+"</div>"+maxScore[j];allRanking.append(singleRanking)}}}}}function StartSetting(){MusicPlay=localStorage.getItem("MusicPlay")==="false"?true:false;if(MusicPlay==null){MusicPlay=false}else{SettingMusic()}RotatePlay=localStorage.getItem("RotatePlay")==="false"?true:false;if(RotatePlay==null){RotatePlay=false}else{Settingrotate()}}function flush(){window.location.reload()}function RankingDisplay(activity){if(activity=="none"){if(Game==true){autoDown(Speed)}else{clearInterval(mInterval)}}else{clearInterval(mInterval)}document.getElementById("RankingArea").style.display=activity}function SettingDisplay(activity){if(activity=="none"){if(Game==true){autoDown(Speed)}else{clearInterval(mInterval)}}else{clearInterval(mInterval)}document.getElementById("SettingArea").style.display=activity}function SettingMusic(){if(MusicPlay==false){MusicPlay=true;localStorage.setItem("MusicPlay",MusicPlay);document.getElementById("SettingMusic").innerText="✔"}else{if(MusicPlay==true){MusicPlay=false;localStorage.setItem("MusicPlay",MusicPlay);document.getElementById("SettingMusic").innerHTML=""}}}function Settingrotate(){var Allblcok=document.getElementsByClassName("activity_model");if(RotatePlay==false){RotatePlay=true;document.getElementById("SettingRotate").innerText="✔";localStorage.setItem("RotatePlay",RotatePlay);for(var i=0;i<Allblcok.length;i++){var singelblock=Allblcok[i];singelblock.style.transition="all 0.1s ease 0s"}}else{if(RotatePlay==true){RotatePlay=false;document.getElementById("SettingRotate").innerHTML="";localStorage.setItem("RotatePlay",RotatePlay);for(var i=0;i<Allblcok.length;i++){var singelblock=Allblcok[i];singelblock.style.transition="none"}}}singelblock=null
}function onTouch(){document.getElementById("TouchArea").addEventListener("touchstart",function(e){e.preventDefault();startX=e.changedTouches[0].pageX,startY=e.changedTouches[0].pageY;oldX=currentX;oldY=currentY});document.getElementById("TouchArea").addEventListener("touchend",function(e){e.preventDefault();EndX=e.changedTouches[0].pageX,EndY=e.changedTouches[0].pageY;if(EndX-startX==0){rotate()}});document.getElementById("TouchArea").addEventListener("touchmove",function(e){e.preventDefault();moveEndX=e.changedTouches[0].pageX;moveEndY=e.changedTouches[0].pageY;thex=Math.abs(moveEndX-startX);they=Math.abs(moveEndY-startY);if(thex>they){var d=moveEndX-startX;var n=parseInt(d/STEP);var targetX=oldX+n;if(targetX>COL_COUNT){}if(targetX<-2){}if(targetX!=currentX){if(targetX>currentX){nowx=targetX-currentX;for(var i=0;i<nowx;i++){move(1,0)}}else{nowx=currentX-targetX;for(var i=0;i<nowx;i++){move(-1,0)}}}}else{if(thex<they){var d=moveEndY-startY;if(d>40){autoDown(35)}}}});d=null;n=null};